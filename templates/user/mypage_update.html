{% extends "base.html" %}
{% load static %}

{% block extra_css %}
  {# 마이페이지 공통 레이아웃 + 수정 폼 전용 CSS #}
  <link rel="stylesheet" href="{% static 'css/mypage.css' %}?v=20251128_2">
  <link rel="stylesheet" href="{% static 'css/mypage_update.css' %}?v=20251128_2">
{% endblock %}

{% block content %}
<div id="canvas" role="main" aria-labelledby="pageTitle">
  <!-- 마이페이지 상단 배너 -->
  <div id="bgMypage"></div>
  <h1 id="pageTitle">마이페이지</h1>

  <!-- 좌측 메뉴 -->
  <div id="menuTitle">메뉴</div>
  <div id="menuBox"></div>
  <div id="menuLine1"></div>
  <div id="menuLine2"></div>
  <a id="menuItem1" href="{% url 'user:mypage' %}">내 정보</a>
  <a id="menuItem2" href="{% url 'user:DIMC_archive' %}">DIMC 아카이브</a>

  <!-- 우측 카드: 내 정보 수정 -->
  <div id="infoBox">
    <h2 class="card-title">내 정보 수정</h2>

    <form id="editForm" method="post" novalidate>
      {% csrf_token %}

      {# name 필드가 필수라면: 숨김으로 현재값 유지 #}
      <input type="hidden" name="name" value="{{ request.user.name|default_if_none:'' }}">

      <div class="panel">

        {# 연락처 #}
        <div class="row row-phone">
          <label class="lbl">연락처</label>
          <div class="main">
            <span class="masked">
              {% if request.user.phone_number %}
                {% with pn=request.user.phone_number|cut:"-" %}
                  {{ pn|slice:":3" }}-*****-{{ pn|slice:"-4:" }}
                {% endwith %}
              {% else %}010-*****-0000{% endif %}
            </span>

            <div class="inputs phone">
              <input type="text" inputmode="numeric" maxlength="3" class="ph" id="ph1" aria-label="국번">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph2" aria-label="중간번호">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph3" aria-label="끝번호">
            </div>
          </div>

          <button type="button" class="btn-mini js-edit" data-focus="#ph1">수정</button>

          {# 서버 전송용 원본 값 #}
          <input type="tel" name="phone_number" id="phoneRaw" class="sr-only"
                 value="{{ request.user.phone_number|default_if_none:'' }}">
        </div>

        {# 이메일(아이디) : 보기만 #}
        <div class="row row-email">
          <label class="lbl">이메일(아이디)</label>
          <div class="main">
            <span class="masked">
              {% if request.user.email %}{{ request.user.email }}{% else %}-{% endif %}
            </span>
            <input class="text" type="email" value="{{ request.user.email }}" disabled>
          </div>
          <button type="button" class="btn-mini" disabled>수정</button>
        </div>

        {# 주소 #}
        <div class="row row-addr">
          <label class="lbl">주소</label>
          <div class="main">
            <span class="masked">
              {% if request.user.address %}
                {{ request.user.address|slice:":5" }}******
              {% else %}-{% endif %}
            </span>
            <input class="text wide" type="text" id="addr" name="address"
                   value="{{ request.user.address|default_if_none:'' }}"
                   placeholder="주소를 입력해 주세요.">
          </div>
          <button type="button" class="btn-mini js-edit" data-focus="#addr">수정</button>
        </div>

        {# 생년월일 #}
        <div class="row row-birth">
          <label class="lbl">생년월일</label>
          <div class="main">
            <span class="masked">
              {% if request.user.birthday %}
                {{ request.user.birthday|date:"Y" }}-**-**
              {% else %}20**-**-**{% endif %}
            </span>

            <div class="inputs birth" id="birthInputs">
              <input type="text" inputmode="numeric" maxlength="4" class="yr" id="by" placeholder="YYYY">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="mo" id="bm" placeholder="MM">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="dy" id="bd" placeholder="DD">
            </div>
          </div>

          <button type="button" class="btn-mini js-edit" data-focus="#by">수정</button>

          {# 서버 전송용 원본 값 #}
          <input type="hidden" name="birthday" id="birthRaw"
                 value="{% if request.user.birthday %}{{ request.user.birthday|date:'Y-m-d' }} 00:00:00{% endif %}">
        </div>

      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save">저장</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  // ===== [A] "수정" 버튼 토글 =====
  const allRows = Array.from(document.querySelectorAll('#infoBox .row'));

  document.querySelectorAll('#infoBox .btn-mini.js-edit').forEach(btn => {
    btn.addEventListener('click', () => {
      const row = btn.closest('.row');
      if (!row) return;

      // 한 번에 한 줄만 편집
      allRows.forEach(r => { if (r !== row) r.classList.remove('editing'); });

      row.classList.toggle('editing');

      // 포커스 이동
      if (row.classList.contains('editing')) {
        const sel = btn.dataset.focus;
        if (sel) {
          const target = row.querySelector(sel) || document.querySelector(sel);
          if (target) target.focus();
        }
      }
    });
  });

  // ===== [B] 폰/생년월일 입력 보조 + 전송값 조립 =====
  const ph = ['ph1','ph2','ph3'].map(id => document.getElementById(id));
  const phoneRaw = document.getElementById('phoneRaw');

  const by = document.getElementById('by'),
        bm = document.getElementById('bm'),
        bd = document.getElementById('bd'),
        birthRaw = document.getElementById('birthRaw');

  // 기존값을 입력칸에도 채우기(값 보존)
  if (phoneRaw && phoneRaw.value) {
    const parts = phoneRaw.value.trim().split('-');
    if (parts.length === 3) {
      if (ph[0]) ph[0].value = parts[0] || '';
      if (ph[1]) ph[1].value = parts[1] || '';
      if (ph[2]) ph[2].value = parts[2] || '';
    }
  }
  if (birthRaw && birthRaw.value) {
    const m = birthRaw.value.trim().match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) {
      if (by) by.value = m[1];
      if (bm) bm.value = m[2];
      if (bd) bd.value = m[3];
    }
  }

  // 숫자만 + 자동 다음칸
  [ ...ph, by, bm, bd ].forEach(inp => {
    if (!inp) return;
    inp.addEventListener('input', e => {
      e.target.value = e.target.value.replace(/[^0-9]/g,'');
      const max = e.target.maxLength || 0;
      if (max && e.target.value.length >= max) {
        const order = [ ...ph, by, bm, bd ];
        const i = order.indexOf(e.target);
        if (i > -1 && order[i+1]) order[i+1].focus();
      }
    });
  });

  // 제출 직전 값 조립
  document.getElementById('editForm').addEventListener('submit', () => {
    // phone_number
    if (ph[0] && ph[1] && ph[2]) {
      const p1 = ph[0].value.trim(),
            p2 = ph[1].value.trim(),
            p3 = ph[2].value.trim();
      if (p1 && p2 && p3) {
        phoneRaw.value = `${p1}-${p2}-${p3}`;
      }
      // 세 칸 중 하나라도 비면 기존 phoneRaw 유지
    }

    // birthday
    if (by && bm && bd) {
      const y = by.value.padStart(4,'0'),
            m = bm.value.padStart(2,'0'),
            d = bd.value.padStart(2,'0');
      if (/^\d{4}$/.test(y) && /^\d{2}$/.test(m) && /^\d{2}$/.test(d)) {
        birthRaw.value = `${y}-${m}-${d} 00:00:00`;
      }
      // 형식 안 맞으면 기존 birthRaw 유지
    }
  });
})();
</script>
{% endblock %}
